**开发方向与规划建议 (分阶段进行):**

考虑到功能的复杂性和依赖关系，我建议我们按照以下阶段和顺序逐步推进：

**核心原则：**

- **先主干后分支：** 先实现核心的、被其他功能依赖的功能。
- **数据驱动：** 大部分功能都围绕着核心数据实体（客户、订单、产品项等）展开。
- **小步快跑，迭代验证：** 每个阶段完成后，尽可能进行测试和验证，确保基础稳固。

------



**阶段一：完善客户管理 (CRM) - 当前已部分完成**

- **目标:** 建立完整的客户信息管理能力。
- **已完成:** 客户列表展示、搜索、添加（通过对话框）、删除。
- **待完成:**
  1. **客户编辑功能:**
     - 在客户列表项上添加“编辑”按钮或使列表项可点击进入编辑模式。
     - 创建一个客户编辑界面/对话框，预填充现有客户信息。
     - 实现保存更新的逻辑 (ViewModel, Repository, DAO)。
  2. **客户详情查看页面 (可选，初期可简化):**
     - 一个单独的屏幕展示客户的所有信息，以及未来可能关联的订单列表、回访记录等。初期如果编辑功能完善，此项优先级可稍低。

------



**阶段二：核心订单管理 - 订单的创建与基础查看**

- **目标:** 实现订单的创建和基本信息的查看，这是整个系统的核心。
- **前置依赖:** 客户管理基本完善 (至少能选择客户)。
- **步骤:**
  1. **订单列表界面 (OrderListScreen):**
     - 类似于 CustomerListScreen，显示订单列表 (初期可显示订单号、客户名、下单日期、总金额、状态)。
     - 提供添加订单的入口 (如 FAB)。
     - 实现基础的订单搜索/筛选 (按客户、状态等)。
  2. **订单 Repository 和 ViewModel (OrderRepository, OrderViewModel):**
     - 创建对应的 Repository 和 ViewModel 来处理订单数据。
     - 注入 OrderDao, OrderItemDao, CustomerDao (可能需要获取客户列表用于选择)。
  3. **创建新订单界面 (AddEditOrderScreen):**
     - **选择客户:** 提供方式从现有客户列表中选择一个客户与订单关联。
     - **填写订单基本信息:** 下单日期 (可默认为当前)、订单备注等。
     - **添加订单项 (OrderItem):**
       - 这是订单创建的核心。需要一个机制来添加多个产品条目。
       - 对于每个条目，需要记录：产品名称 (初期可手输，或从未来的产品目录选择)、数量、单价、(可选) 颜色、尺寸、备注。
       - 动态计算每个订单项的小计金额。
     - **计算订单总金额、优惠、应付金额、首付款。**
     - **选择订单跟进人 (Staff):** 从店员列表中选择一个或多个负责人 (需要先实现基础的店员数据)。
     - **保存订单及订单项:**
       - ViewModel 将订单信息 (Order) 和所有订单项信息 (List<OrderItem>) 发送给 Repository。
       - Repository 需要在一个事务中保存 Order 和所有关联的 OrderItem (确保 OrderItem 的 orderId 正确关联)。
  4. **订单详情查看界面 (OrderDetailScreen - 初版):**
     - 点击订单列表中的订单，跳转到此界面。
     - 显示订单的详细信息、关联的客户信息、以及包含的所有订单项列表。

------



**阶段三：产品进度跟踪与订单状态联动**

- **目标:** 实现订单中每个产品从“未下单”到“已安装”的状态流转，并根据产品项状态更新订单整体状态。
- **前置依赖:** 核心订单管理功能完成。
- **步骤:**
  1. **完善 OrderItem 状态管理:**
     - 在 OrderItemDao 和 OrderItemRepository 中添加更新 OrderItem.status、相关时间戳 (orderedFromVendorAt, arrivedAtStockAt, installedAt) 和 statusLastUpdateStaffId 的方法。
     - 在 OrderItemViewModel (如果需要单独的 ViewModel，或者在 OrderViewModel 中处理) 中添加处理这些状态更新的逻辑。
  2. **产品进度跟踪界面:**
     - 可以在 OrderDetailScreen 中直接展示和操作每个 OrderItem 的状态。
     - 提供界面元素（如下拉菜单、按钮）让用户（店员）手动更新每个 OrderItem 的进度状态。
     - 记录操作人（签名）。
  3. **订单状态自动更新逻辑:**
     - 当一个 OrderItem 的状态更新为 INSTALLED 时，记录 installedAt。
     - 当一个 Order 下的**所有** OrderItem 都达到 INSTALLED 状态时，自动将 Order.status 更新为 COMPLETED，并记录 Order.completionDate。
     - 订单创建时，Order.status 默认为 PENDING 或 PROCESSING。

------



**阶段四：客户回访管理**

- **目标:** 实现基于订单完成时间和预设间隔的自动回访提醒及记录。
- **前置依赖:** 订单状态能正确更新到 COMPLETED。
- **步骤:**
  1. **回访设置界面 (全局或客户级别):**
     - 允许商家设置默认的回访间隔序列 (如1个月、3个月、6个月、1年...)。
  2. **自动生成首次回访计划:**
     - 当 Order.status 变为 COMPLETED 时，根据回访设置，自动在 FollowUp 表中创建一条 status = PENDING 的首次回访计划记录，包含 scheduledDate。
  3. **待回访列表界面:**
     - 显示所有 status = PENDING 且 scheduledDate 小于等于今天的 FollowUp 记录。
  4. **执行回访与记录界面:**
     - 允许商家查看待回访详情，记录回访内容 (FollowUp.notes)、实际回访日期 (actualFollowUpDate)、操作人 (staffId)。
     - 将 FollowUp.status 更新为 COMPLETED。
     - 根据回访策略，自动生成**下一次**的 PENDING 回访计划。
  5. **回访历史查看:** 在客户详情或订单详情中展示相关的回访记录。

------



**阶段五：收款与商家账目管理**

- **目标:** 管理订单收款和记录商家日常收支。
- **前置依赖:** 订单创建功能。
- **步骤:**
  1. **收款管理界面:**
     - 在订单详情中显示订单应付金额、已付金额（首付+后续收款）、未结款。
     - 提供功能记录新的收款 (Payment)，包括收款金额、日期、方式、收款人。
     - 每次收款后更新订单的已付和未结款状态。
  2. **商家账目记录界面 (LedgerScreen):**
     - 列表显示所有 LedgerEntry (区分收入和支出)。
     - 提供筛选功能 (按日期、类型)。
     - 提供手动添加入账（如其他收入）和出账（如房租、采购成本）的功能。
  3. **自动关联 (可选):**
     - 当创建一条 Payment 记录时，可以选择是否自动在 LedgerEntry 中创建一条对应的 INCOME 记录。

------



**阶段六：店员管理与权限控制 (迭代完善)**

- **目标:** 管理店员账户，并根据角色实现基本的操作权限。
- **步骤:**
  1. **店员登录界面 (如果需要多用户分别登录)。**
  2. **店员管理界面 (老板权限):**
     - 添加、编辑、查看店员信息 (Staff 表)，设置角色 (StaffRole)。
     - 激活/禁用店员账户。
  3. **操作记录与签名:** 确保所有关键操作 (如订单状态变更、收款、回访记录) 都已记录操作的 staffId (这个在 V3 数据库设计中已经考虑)。
  4. **权限控制 (逐步实现):**
     - **初期:** 简单地根据当前登录用户的角色，在 UI层面显示/隐藏某些操作按钮或菜单项。
     - **后期 (可选):** 更细致的权限控制，可能需要更复杂的权限模型。

------



**规划建议总结:**

1. **当前紧要任务：完成阶段一的“客户编辑功能”。** 这是完善 CRM 的基础。
2. **接下来重点攻克阶段二：“核心订单管理”。** 这是整个系统的核心功能，其他很多功能都依赖于订单数据。特别是“添加订单项”的交互和数据处理会是这个阶段的难点。
3. 然后按顺序推进阶段三、四、五。
4. 阶段六的店员管理和权限可以穿插在其他阶段进行，或者作为一个独立的迭代周期。

**对于“不知道代码怎么写”：**

- 当我们进入每个阶段的每个小步骤时（比如“创建客户编辑界面”），我会提供更具体的指导，包括需要创建哪些文件、哪些 Composable 函数、ViewModel 中需要哪些方法、数据如何流动等。
- 我们会大量参考已有的代码（如 CustomerListScreen 和 CustomerViewModel）。
- **你当前最重要的是理解每个阶段的目标，以及这个目标分解下的小步骤。** 这样你就能更好地提问和参与到具体的编码过程中。